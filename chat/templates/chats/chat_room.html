{% extends "chats/base_chat.html" %}
{% load staticfiles %}
{% block header %}
{{ block.super }}
 <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.10.2/jquery.min.js"></script>
 <script type="text/javascript" src="{% static "jquery.gracefulWebSocket.js" %}"></script>
 <script type="text/javascript">
    $(document).ready( function() {

    function register_msg(message_id){
       var selector = '.'+message_id;
       $(selector).on('click', function(event) {
         chat.send({command: 'like', ref: message_id, user: '{{ user }}'}); 
       });
    }

    window.chat = {};
    chat.ws = $.gracefulWebSocket("ws://127.0.0.1:1025/ws");
    chat.send = function (message) {
      chat.ws.send(JSON.stringify(message));
    }

    chat.ws.onmessage = function (event) {
      var messageFromServer = event.data;
      var list_element = document.createElement('li');
      var msg = $.parseJSON(messageFromServer);
      if (msg.command){
       if (msg.command == 'like'){
           list_element.innerHTML = '<a href="#" data-id='+msg.id+' class="'+msg.id+'"> Meessage:' + msg.user +' liked your post</a>';
         }
      }
      else{
        list_element.innerHTML = '<a href="#" data-id='+msg.id+' class="'+msg.id+'"> Meessage:' + msg.msg +'</a>';
      }
      $("#message_list ul").append(list_element);
      register_msg(msg.id);
    };

    var inputBox = document.getElementById("inputbox");

    inputbox.addEventListener("keydown", function(e) {
      if (!e) { var e = window.event; }

      if (e.keyCode == 13) { 
        e.preventDefault(); // sometimes useful
        chat.send({msg: inputbox.value, user: '{{ user }}', command: null });  
        inputbox.value="";
      }
    }, false);

    });
 </script>
<h1> {{ user }} </h1>
{% endblock %}
